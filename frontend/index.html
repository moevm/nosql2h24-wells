<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта и список</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <div class="col-md-4 pt-3 overflow-auto">

                <section id="courtyards" class="h-60">
                    <div class="search mb-3 d-flex align-items-center">
                        <input type="text" class="form-control mr-2" placeholder="Поиск по дворам">
                        <a class="btn btn-primary" href="advanced_courtyard_search.html">
                            <span class="material-icons">settings</span>
                        </a>
                    </div>
                    <div class="list-group" id="courtyards-list">
                        
                    </div>
                </section>
                <section id="users" class="h-40">
                    <div class="search my-3 d-flex align-items-center">
                        <input type="text" class="form-control mr-2" placeholder="Поиск по пользователям">
                        <a class="btn btn-primary" href="advanced_user_search.html">
                            <span class="material-icons">settings</span>
                        </a>
                    </div>
                    <div class="list-group" id="users-list">
                        
                    </div>
                </section>
            </div>
            <div class="col-md-8 p-0">
                <div id="map" class="w-100 h-100"></div>
            </div>
        </div>
    </div>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://api-maps.yandex.ru/2.0-stable/?apikey=0faafbbe-1718-4c19-b6e2-46f316ed4ba5&load=package.full&lang=ru-RU" type="text/javascript"></script>
    <script src="scripts/templates.js"></script>
    <script>
        ymaps.ready(init);

        function init() {
            // settings
            var myMap = new ymaps.Map ('map', {
                center: [59.9342802, 30.3350986], // lat lon
                zoom: 13
            });
            myMap.controls
                .add('mapTools')       // стандартные кнопки
                .add('typeSelector')   // переключатель типа карты
                .add('zoomControl');   // изменение масштаба
            
            // placemarks
            fetch('http://localhost:8081/courtyards', { 
                // mode: 'no-cors', 
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then((resp) => resp.json().then((body) => {
                    let list = document.getElementById("users-list");
                    for (let index = 0; index < body.length; index++) {
                        let data = body[index];
                        console.log(data)
                        
                        let courtyard_id = data['id'];
                        let title = data['title'];
                        let address = data['houses'][0]["address"];
                        let visited = data['visitors_count'];
                        let rating = data["average_rating"];

                        let cardc = generateCourtyardCard(title, address, rating, courtyard_id)
                        let listc = document.getElementById("courtyards-list");
                        listc.innerHTML += cardc;
                        
                        
                        let coordinates = [];
                        for (let i = 0; i < data['coordinates'].length; i++) {
                            const coord = data['coordinates'][i];
                            coordinates.push([coord['latitude'], coord['longitude']]);
                        }
                        console.log(coordinates);

                        let mean_lat = 0;
                        let mean_lon = 0;
                        for (let i = 0; i < coordinates.length; i++) {
                            const latlon = coordinates[i];
                            mean_lat += coordinates[i][0];
                            mean_lon += coordinates[i][1];
                        }
                        mean_lat /= coordinates.length;
                        mean_lon /= coordinates.length;
                        
                        var myPlacemark = new ymaps.Placemark([mean_lat, mean_lon], { 
                            iconContent: title,
                            id: courtyard_id
                        }, {
                            // Опции
                            preset: 'twirl#blueStretchyIcon' // иконка растягивается под контент
                        });
                        myPlacemark.events.add(['click'], function(e) {
                            window.location.assign('courtyard.html?id=' + e.get('target').properties._data.id);
                        });

                        var myPolygon = new ymaps.Polygon([coordinates]);
                        myMap.geoObjects.add(myPolygon);
                        myMap.geoObjects.add(myPlacemark);
                    }
                })); 
        }
        // https://tokmakov.msk.ru/blog/item/16

        window.onload = () => {
            fetch('http://localhost:8081/users?limit=10', { 
                // mode: 'no-cors', 
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then((resp) => resp.json().then((body) => {
                    let list = document.getElementById("users-list");
                    for (let index = 0; index < body.length; index++) {
                        let data = body[index];
                        let username = data['nickname'];
                        let last_name = data['last_name'];
                        let first_name = data['first_name'];
                        let patronymic = data['patronymic'];
                        let visited = data['visited_courtyards'];

                        let card = generateUserCard(username, last_name, first_name, patronymic, visited)
                        list.innerHTML += card;
                    }
                })); 
            // -----
            
        }
    </script>
</body>
</html>

<!-- 13:54 -->